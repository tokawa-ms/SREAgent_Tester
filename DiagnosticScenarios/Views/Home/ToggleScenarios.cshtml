@using Microsoft.Extensions.Localization
@inject IHtmlLocalizer<DiagnosticScenarios.Resources.SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["ToggleScenarios.Title"];
}

<div class="row">
    <div class="col-md-12">
        <h1 class="text-center mb-4">@Localizer["ToggleScenarios.Title"]</h1>
        <div class="alert alert-info">
            <strong>@Localizer["Common.Warning"]:</strong> @Localizer["ToggleScenarios.Warning"]
        </div>
    </div>
</div>

<div class="row">
    <!-- Á¢∫ÁéáÁöÑ‰æãÂ§ñ„Ç∑„Éä„É™„Ç™ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" data-scenario="ProbabilisticFailure">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üéØ @Localizer["ToggleScenarios.ProbabilisticFailure"]</h5>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input scenario-toggle" type="checkbox" id="toggle-ProbabilisticFailure" data-scenario="ProbabilisticFailure">
                </div>
            </div>
                <div class="card-body">
                    <form id="form-ProbabilisticFailure" class="scenario-form">
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.DurationMinutes"]</span>
                            <input class="form-control" type="number" name="durationMinutes" value="1" min="1" max="180" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.RequestsPerSecond"]</span>
                            <input class="form-control" type="number" name="requestsPerSecond" value="10" min="1" max="1000" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.FailurePercentage"]</span>
                            <input class="form-control" type="number" name="failurePercentage" value="10" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                    </form>
                    <div class="mt-3" id="status-ProbabilisticFailure">
                        <small class="text-muted">@Localizer["Common.Stopped"]</small>
                    </div>
                </div>
            </div>
        </div>

    <!-- CPU „Çπ„Éë„Ç§„ÇØ„Ç∑„Éä„É™„Ç™ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" data-scenario="CpuSpike">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üî• @Localizer["ToggleScenarios.CpuSpike"]</h5>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input scenario-toggle" type="checkbox" id="toggle-CpuSpike" data-scenario="CpuSpike">
                    </div>
                </div>
                <div class="card-body">
                    <form id="form-CpuSpike" class="scenario-form">
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.DurationMinutes"]</span>
                            <input class="form-control" type="number" name="durationMinutes" value="1" min="1" max="180" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.IntervalSeconds"]</span>
                            <input class="form-control" type="number" name="intervalSeconds" value="10" min="1" max="300" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.TriggerPercentage"]</span>
                            <input class="form-control" type="number" name="triggerPercentage" value="30" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">@Localizer["ToggleScenarios.SpikeSeconds"]</span>
                            <input class="form-control" type="number" name="spikeSeconds" value="5" min="1" max="30" required>
                        </div>
                    </form>
                    <div class="mt-3" id="status-CpuSpike">
                        <small class="text-muted">@Localizer["Common.Stopped"]</small>
                    </div>
                </div>
            </div>
        </div>

    <!-- „É°„É¢„É™„É™„Éº„ÇØ„Ç∑„Éä„É™„Ç™ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" data-scenario="MemoryLeak">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üîÑ @Localizer["ToggleScenarios.MemoryLeak"]</h5>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input scenario-toggle" type="checkbox" id="toggle-MemoryLeak" data-scenario="MemoryLeak">
                </div>
            </div>
            <div class="card-body">
                <form id="form-MemoryLeak" class="scenario-form">
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.DurationMinutes"]</span>
                        <input class="form-control" type="number" name="durationMinutes" value="1" min="1" max="180" required>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.IntervalSeconds"]</span>
                        <input class="form-control" type="number" name="intervalSeconds" value="5" min="1" max="300" required>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.TriggerPercentage"]</span>
                        <input class="form-control" type="number" name="triggerPercentage" value="20" min="0" max="100" required>
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.MemoryMegabytes"]</span>
                        <input class="form-control" type="number" name="memoryMegabytes" value="100" min="1" max="1024" required>
                        <span class="input-group-text">MB</span>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.HoldSeconds"]</span>
                        <input class="form-control" type="number" name="holdSeconds" value="10" min="1" max="60" required>
                    </div>
                </form>
                <div class="mt-3" id="status-MemoryLeak">
                    <small class="text-muted">@Localizer["Common.Stopped"]</small>
                </div>
                </div>
            </div>
        </div>

    <!-- Á¢∫ÁéáÁöÑ„É¨„Ç§„ÉÜ„É≥„Ç∑„Éº„Ç∑„Éä„É™„Ç™ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100" data-scenario="ProbabilisticLatency">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚è≥ @Localizer["ToggleScenarios.ProbabilisticLatency"]</h5>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input scenario-toggle" type="checkbox" id="toggle-ProbabilisticLatency" data-scenario="ProbabilisticLatency">
                </div>
            </div>
            <div class="card-body">
                <form id="form-ProbabilisticLatency" class="scenario-form">
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.DurationMinutes"]</span>
                        <input class="form-control" type="number" name="durationMinutes" value="1" min="1" max="180" required>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.RequestsPerSecond"]</span>
                        <input class="form-control" type="number" name="requestsPerSecond" value="10" min="1" max="1000" required>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.TriggerPercentage"]</span>
                        <input class="form-control" type="number" name="triggerPercentage" value="40" min="0" max="100" required>
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">@Localizer["ToggleScenarios.DelayMilliseconds"]</span>
                        <input class="form-control" type="number" name="delayMilliseconds" value="500" min="1" max="10000" required>
                        <span class="input-group-text">ms</span>
                    </div>
                </form>
                <div class="mt-3" id="status-ProbabilisticLatency">
                    <small class="text-muted">@Localizer["Common.Stopped"]</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const scenarioEndpoints = {
            ProbabilisticFailure: {
                start: '/api/ScenarioToggle/probabilistic-failure/start',
                stop: '/api/ScenarioToggle/probabilistic-failure/stop',
                fields: ['durationMinutes', 'requestsPerSecond', 'failurePercentage']
            },
            CpuSpike: {
                start: '/api/ScenarioToggle/cpu-spike/start',
                stop: '/api/ScenarioToggle/cpu-spike/stop',
                fields: ['durationMinutes', 'intervalSeconds', 'triggerPercentage', 'spikeSeconds']
            },
            MemoryLeak: {
                start: '/api/ScenarioToggle/memory-leak/start',
                stop: '/api/ScenarioToggle/memory-leak/stop',
                fields: ['durationMinutes', 'intervalSeconds', 'triggerPercentage', 'memoryMegabytes', 'holdSeconds']
            },
            ProbabilisticLatency: {
                start: '/api/ScenarioToggle/probabilistic-latency/start',
                stop: '/api/ScenarioToggle/probabilistic-latency/stop',
                fields: ['durationMinutes', 'requestsPerSecond', 'triggerPercentage', 'delayMilliseconds']
            }
        };

        document.querySelectorAll('.scenario-toggle').forEach(toggle => {
            toggle.addEventListener('change', async (event) => {
                const scenario = event.target.dataset.scenario;
                event.target.disabled = true;
                try {
                    if (event.target.checked) {
                        await startScenario(scenario);
                    } else {
                        await stopScenario(scenario);
                    }
                    await refreshStatuses();
                } catch (error) {
                    alert(`@Localizer["Common.Error"]: ${error.message}`);
                    event.target.checked = !event.target.checked;
                } finally {
                    event.target.disabled = false;
                }
            });
        });

        async function startScenario(scenario) {
            const config = scenarioEndpoints[scenario];
            const form = document.getElementById(`form-${scenario}`);
            const payload = {};
            config.fields.forEach(field => {
                const input = form.querySelector(`[name="${field}"]`);
                payload[field] = Number(input.value);
            });

            const response = await fetch(config.start, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const message = await response.text();
                throw new Error(message || 'Failed to start');
            }
        }

        async function stopScenario(scenario) {
            const response = await fetch(scenarioEndpoints[scenario].stop, { method: 'POST' });
            if (!response.ok) {
                const message = await response.text();
                throw new Error(message || 'Failed to stop');
            }
        }

        async function refreshStatuses() {
            try {
                const response = await fetch('/api/ScenarioToggle/status');
                if (!response.ok) {
                    throw new Error('Failed to get status');
                }

                const statuses = await response.json();
                statuses.forEach(updateScenarioStatus);
            } catch (error) {
                console.warn(error);
            }
        }

        function updateScenarioStatus(status) {
            const toggle = document.getElementById(`toggle-${status.scenario}`);
            const statusLabel = document.getElementById(`status-${status.scenario}`);
            if (!toggle || !statusLabel) {
                return;
            }

            toggle.checked = status.isActive;
            let message = status.lastMessage || '@Localizer["Common.Stopped"]';
            if (status.isActive && status.endsAtUtc) {
                const localTime = new Date(status.endsAtUtc).toLocaleTimeString();
                message = `@Localizer["Common.Active"] (${localTime})`;
            }

            statusLabel.textContent = message;
        }

        refreshStatuses();
        setInterval(refreshStatuses, 5000);
    </script>
}
